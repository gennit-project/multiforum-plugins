name: Publish Plugins

on:
  push:
    tags:
      - '*@*'  # e.g., hello-world@0.2.2

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      GCS_BUCKET: mf-plugins-prod
      GCP_UPLOAD_PREFIX: plugins
      REGISTRY_OBJECT: registry.json

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      # Authenticate to GCP (Workload Identity Federation recommended)
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Parse tag
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          PLUGIN_ID="${TAG%@*}"
          VERSION="${TAG#*@}"
          if [ -z "$PLUGIN_ID" ] || [ -z "$VERSION" ] || [ "$PLUGIN_ID" = "$VERSION" ]; then
            echo "Invalid tag format: $TAG (expected <plugin-id>@<version>)" >&2
            exit 1
          fi
          echo "PLUGIN_ID=$PLUGIN_ID" >> "$GITHUB_ENV"
          echo "PLUGIN_VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Install deps & build plugin
        run: |
          set -euo pipefail
          # Install root dependencies first (includes TypeScript)
          npm ci

          PLUGIN_DIR="plugins/${PLUGIN_ID}"
          if [ ! -d "$PLUGIN_DIR" ] || [ ! -f "$PLUGIN_DIR/plugin.json" ]; then
            echo "Plugin ${PLUGIN_ID} not found under $PLUGIN_DIR" >&2
            exit 1
          fi

          MANIFEST_VERSION=$(jq -r '.version' "$PLUGIN_DIR/plugin.json")
          if [ -z "$MANIFEST_VERSION" ] || [ "$MANIFEST_VERSION" = "null" ]; then
            echo "Missing version in $PLUGIN_DIR/plugin.json" >&2
            exit 1
          fi
          if [ "$MANIFEST_VERSION" != "$PLUGIN_VERSION" ]; then
            echo "Tag version $PLUGIN_VERSION does not match manifest $MANIFEST_VERSION for $PLUGIN_ID" >&2
            exit 1
          fi

          if [ -f "$PLUGIN_DIR/package.json" ]; then
            (cd "$PLUGIN_DIR" && npm ci && npm run build)
          fi

      - name: Pack deterministic tarballs and compute sha256
        run: |
          set -euo pipefail
          npm run bundle:create -- --plugin "${PLUGIN_ID}"

      - name: Upload tarballs to GCS
        run: |
          set -euo pipefail
          TGZ="out/${PLUGIN_ID}-${PLUGIN_VERSION}.tgz"
          SHA_FILE="out/${PLUGIN_ID}-${PLUGIN_VERSION}.sha256"
          if [ ! -f "$TGZ" ] || [ ! -f "$SHA_FILE" ]; then
            echo "Missing bundle or hash for ${PLUGIN_ID}@${PLUGIN_VERSION}" >&2
            exit 1
          fi

          gcloud storage cp "$TGZ"      "gs://${GCS_BUCKET}/${GCP_UPLOAD_PREFIX}/${PLUGIN_ID}/${PLUGIN_VERSION}/bundle.tgz"
          gcloud storage cp "$SHA_FILE" "gs://${GCS_BUCKET}/${GCP_UPLOAD_PREFIX}/${PLUGIN_ID}/${PLUGIN_VERSION}/bundle.sha256"

          # Convenience: upload a copy of plugin.json next to the tarball
          TMPDIR=$(mktemp -d)
          tar -xzf "$TGZ" -C "$TMPDIR"
          gcloud storage cp "${TMPDIR}/plugin.json" "gs://${GCS_BUCKET}/${GCP_UPLOAD_PREFIX}/${PLUGIN_ID}/${PLUGIN_VERSION}/plugin.json"

      - name: Generate registry.json and upload
        run: |
          set -euo pipefail
          # Fetch existing registry if present (merge in place)
          gcloud storage cp "gs://${GCS_BUCKET}/${REGISTRY_OBJECT}" registry.json || true

          npm run registry:generate -- \
            --plugin "${PLUGIN_ID}" \
            --bucket "gs://${GCS_BUCKET}" \
            --output registry.json

          gcloud storage cp registry.json "gs://${GCS_BUCKET}/${REGISTRY_OBJECT}"
